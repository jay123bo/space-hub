import React, { useEffect, useRef, useState } from 'react';
import * as THREE from 'three';

const CivilWarCinematic = () => {
  const mountRef = useRef(null);
  const [phase, setPhase] = useState('title'); // title, battle, end

  useEffect(() => {
    // Scene setup
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1410);
    scene.fog = new THREE.Fog(0x2d1810, 10, 50);

    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 5, 15);
    camera.lookAt(0, 2, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    mountRef.current.appendChild(renderer.domElement);

    // Lighting
    const ambientLight = new THREE.AmbientLight(0xffd9b3, 0.4);
    scene.add(ambientLight);

    const sunLight1 = new THREE.DirectionalLight(0xffd966, 0.8);
    sunLight1.position.set(-10, 15, 5);
    sunLight1.castShadow = true;
    sunLight1.shadow.camera.left = -20;
    sunLight1.shadow.camera.right = 20;
    sunLight1.shadow.camera.top = 20;
    sunLight1.shadow.camera.bottom = -20;
    scene.add(sunLight1);

    const sunLight2 = new THREE.DirectionalLight(0xffcc66, 0.5);
    sunLight2.position.set(-8, 12, 8);
    scene.add(sunLight2);

    // Ground (Tatooine sand)
    const groundGeometry = new THREE.PlaneGeometry(100, 100);
    const groundMaterial = new THREE.MeshStandardMaterial({
      color: 0xd2b48c,
      roughness: 0.9,
      metalness: 0.1
    });
    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Buildings (Tatooine structures)
    const buildings = [];
    const buildingPositions = [
      [-12, 0, -8],
      [-8, 0, -10],
      [10, 0, -9],
      [15, 0, -7]
    ];

    buildingPositions.forEach(pos => {
      const width = 3 + Math.random() * 2;
      const height = 3 + Math.random() * 3;
      const depth = 3 + Math.random() * 2;
      
      const buildingGeometry = new THREE.BoxGeometry(width, height, depth);
      const buildingMaterial = new THREE.MeshStandardMaterial({
        color: 0xc9b99a,
        roughness: 0.8
      });
      const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
      building.position.set(pos[0], height / 2, pos[2]);
      building.castShadow = true;
      building.receiveShadow = true;
      scene.add(building);
      buildings.push(building);

      // Dome on some buildings
      if (Math.random() > 0.5) {
        const domeGeometry = new THREE.SphereGeometry(width / 2, 16, 8, 0, Math.PI * 2, 0, Math.PI / 2);
        const dome = new THREE.Mesh(domeGeometry, buildingMaterial);
        dome.position.set(pos[0], height, pos[2]);
        dome.castShadow = true;
        scene.add(dome);
      }
    });

    // Create R6 Character
    function createR6Character(color, isJedi) {
      const character = new THREE.Group();
      
      // Head
      const headGeometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
      const headMaterial = new THREE.MeshStandardMaterial({ color: 0xffdbac });
      const head = new THREE.Mesh(headGeometry, headMaterial);
      head.position.y = 2.3;
      head.castShadow = true;
      character.add(head);

      // Torso
      const torsoGeometry = new THREE.BoxGeometry(1.2, 1.5, 0.6);
      const torsoMaterial = new THREE.MeshStandardMaterial({ color });
      const torso = new THREE.Mesh(torsoGeometry, torsoMaterial);
      torso.position.y = 1.25;
      torso.castShadow = true;
      character.add(torso);

      // Arms
      const armGeometry = new THREE.BoxGeometry(0.4, 1.2, 0.4);
      const armMaterial = new THREE.MeshStandardMaterial({ color });
      
      const leftArm = new THREE.Mesh(armGeometry, armMaterial);
      leftArm.position.set(-0.8, 1.4, 0);
      leftArm.castShadow = true;
      character.add(leftArm);
      
      const rightArm = new THREE.Mesh(armGeometry, armMaterial);
      rightArm.position.set(0.8, 1.4, 0);
      rightArm.castShadow = true;
      character.add(rightArm);

      // Legs
      const legGeometry = new THREE.BoxGeometry(0.5, 1.2, 0.5);
      const legMaterial = new THREE.MeshStandardMaterial({ color: color });
      
      const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
      leftLeg.position.set(-0.3, 0.4, 0);
      leftLeg.castShadow = true;
      character.add(leftLeg);
      
      const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
      rightLeg.position.set(0.3, 0.4, 0);
      rightLeg.castShadow = true;
      character.add(rightLeg);

      character.userData = { 
        head, torso, leftArm, rightArm, leftLeg, rightLeg,
        walkCycle: 0,
        attackCycle: 0
      };

      return character;
    }

    // Create Lightsaber
    function createLightsaber(color) {
      const saber = new THREE.Group();
      
      // Handle
      const handleGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.6, 8);
      const handleMaterial = new THREE.MeshStandardMaterial({ 
        color: 0x333333,
        metalness: 0.8,
        roughness: 0.2
      });
      const handle = new THREE.Mesh(handleGeometry, handleMaterial);
      saber.add(handle);

      // Blade
      const bladeGeometry = new THREE.CylinderGeometry(0.08, 0.08, 2.5, 8);
      const bladeMaterial = new THREE.MeshStandardMaterial({
        color,
        emissive: color,
        emissiveIntensity: 1,
        transparent: true,
        opacity: 0.9
      });
      const blade = new THREE.Mesh(bladeGeometry, bladeMaterial);
      blade.position.y = 1.55;
      saber.add(blade);

      // Glow
      const glowLight = new THREE.PointLight(color, 2, 3);
      glowLight.position.y = 1.5;
      saber.add(glowLight);

      return saber;
    }

    // Create characters
    const jedi1 = createR6Character(0x8b7355, true);
    jedi1.position.set(-5, 0, 2);
    jedi1.rotation.y = Math.PI / 4;
    scene.add(jedi1);

    const jedi2 = createR6Character(0x6b5345, true);
    jedi2.position.set(-3, 0, 0);
    jedi2.rotation.y = Math.PI / 6;
    scene.add(jedi2);

    const jedi3 = createR6Character(0x7a6350, true);
    jedi3.position.set(-4, 0, -2);
    jedi3.rotation.y = Math.PI / 3;
    scene.add(jedi3);

    const sith1 = createR6Character(0x1a1a1a, false);
    sith1.position.set(5, 0, 2);
    sith1.rotation.y = -Math.PI / 4;
    scene.add(sith1);

    const sith2 = createR6Character(0x0d0d0d, false);
    sith2.position.set(3, 0, 0);
    sith2.rotation.y = -Math.PI / 6;
    scene.add(sith2);

    const sith3 = createR6Character(0x2a2a2a, false);
    sith3.position.set(4, 0, -2);
    sith3.rotation.y = -Math.PI / 3;
    scene.add(sith3);

    // Lightsabers
    const jediSaber1 = createLightsaber(0x00bfff);
    const jediSaber2 = createLightsaber(0x00ff00);
    const jediSaber3 = createLightsaber(0x00bfff);
    const sithSaber1 = createLightsaber(0xff0000);
    const sithSaber2 = createLightsaber(0xff0000);
    const sithSaber3 = createLightsaber(0xff0000);

    jediSaber1.position.set(-5, 1.5, 2);
    jediSaber2.position.set(-3, 1.5, 0);
    jediSaber3.position.set(-4, 1.5, -2);
    sithSaber1.position.set(5, 1.5, 2);
    sithSaber2.position.set(3, 1.5, 0);
    sithSaber3.position.set(4, 1.5, -2);

    scene.add(jediSaber1, jediSaber2, jediSaber3);
    scene.add(sithSaber1, sithSaber2, sithSaber3);

    const allJedi = [jedi1, jedi2, jedi3];
    const allSith = [sith1, sith2, sith3];
    const jediSabers = [jediSaber1, jediSaber2, jediSaber3];
    const sithSabers = [sithSaber1, sithSaber2, sithSaber3];

    // Animation functions
    function animateWalk(character, speed) {
      character.userData.walkCycle += speed;
      const cycle = character.userData.walkCycle;
      
      character.userData.leftLeg.rotation.x = Math.sin(cycle) * 0.5;
      character.userData.rightLeg.rotation.x = Math.sin(cycle + Math.PI) * 0.5;
      character.userData.leftArm.rotation.x = Math.sin(cycle + Math.PI) * 0.3;
      character.userData.rightArm.rotation.x = Math.sin(cycle) * 0.3;
    }

    function animateSaberSwing(character, saber, speed) {
      character.userData.attackCycle += speed;
      const cycle = character.userData.attackCycle;
      
      character.userData.rightArm.rotation.x = Math.sin(cycle * 2) * 1.2 - 0.5;
      character.userData.rightArm.rotation.z = Math.cos(cycle * 2) * 0.3;
      
      saber.rotation.x = Math.sin(cycle * 2) * 1.2 - 0.5;
      saber.rotation.z = Math.cos(cycle * 2) * 0.3;
    }

    // Create energy clash effect
    function createClashEffect(position) {
      const particles = new THREE.Group();
      for (let i = 0; i < 20; i++) {
        const particleGeometry = new THREE.SphereGeometry(0.05, 4, 4);
        const particleMaterial = new THREE.MeshBasicMaterial({
          color: Math.random() > 0.5 ? 0x00bfff : 0xff0000,
          transparent: true,
          opacity: 1
        });
        const particle = new THREE.Mesh(particleGeometry, particleMaterial);
        
        const angle = (i / 20) * Math.PI * 2;
        const speed = Math.random() * 0.2 + 0.1;
        particle.userData = {
          velocity: new THREE.Vector3(
            Math.cos(angle) * speed,
            Math.random() * 0.3,
            Math.sin(angle) * speed
          ),
          life: 1
        };
        particle.position.copy(position);
        particles.add(particle);
      }
      scene.add(particles);
      
      setTimeout(() => scene.remove(particles), 1000);
      return particles;
    }

    // Narration
    const narrationText = `Beneath the light of twin-suns, the Force begins to stir. Those acute to it knew they were in conflict that had not yet emerged.

Force wielders came to inhabit the sands of Tatooine as both Jedi and Sith alike arrived at the rendezvous point just outside of the city of Mos Eisley. Their fear, resolve, and anger ripped through the air like a premonition of the maelstrom to come.

Combatants on each side brace themselves, and with a flash of light, the battle commenced.

Blades of pure energy begin to clash, a representation of their devotion to their cause. The Jedi seized the initiative and worked their way through the opposing Sith forces with little resistance. Mustering their strength, the Sith struck back, and once more streaks of light illuminated the sands of Tatooine; this time, the Sith would demonstrate their innate power, tearing through the battlefield with their relentless aggression. In the end, both sides are left disgruntled; the planet remains in a gridlock, and neither has gained a stronger position.`;

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 0.85;
      utterance.pitch = 1.2;
      utterance.volume = 1;
      
      const voices = speechSynthesis.getVoices();
      const femaleVoice = voices.find(v => 
        v.name.includes('Female') || 
        v.name.includes('Samantha') || 
        v.name.includes('Victoria') ||
        v.name.includes('Zira')
      ) || voices[0];
      utterance.voice = femaleVoice;
      
      speechSynthesis.speak(utterance);
    }

    // Timeline
    let time = 0;
    let battlePhase = 0;
    let clashTimer = 0;

    setTimeout(() => {
      setPhase('battle');
      speak(narrationText);
    }, 4000);

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);
      time += 0.016;
      
      if (phase === 'battle') {
        // Phase 1: Jedi advance (8-14s)
        if (time > 8 && time < 14) {
          allJedi.forEach((jedi, i) => {
            animateWalk(jedi, 0.15);
            jedi.position.x += 0.02;
            jediSabers[i].position.x = jedi.position.x;
          });
        }

        // Phase 2: Battle engagement (14-18s)
        if (time > 14 && time < 18) {
          allJedi.forEach((jedi, i) => {
            animateSaberSwing(jedi, jediSabers[i], 0.1);
          });
          allSith.forEach((sith, i) => {
            animateSaberSwing(sith, sithSabers[i], 0.1);
          });

          clashTimer += 0.016;
          if (clashTimer > 0.5) {
            const clashPos = new THREE.Vector3(
              Math.random() * 4 - 2,
              1.5,
              Math.random() * 4 - 2
            );
            createClashEffect(clashPos);
            clashTimer = 0;
          }
        }

        // Phase 3: Sith counter (18-24s)
        if (time > 18 && time < 24) {
          allSith.forEach((sith, i) => {
            animateWalk(sith, 0.2);
            sith.position.x -= 0.03;
            sithSabers[i].position.x = sith.position.x;
            animateSaberSwing(sith, sithSabers[i], 0.15);
          });

          // More intense clashing
          clashTimer += 0.016;
          if (clashTimer > 0.3) {
            const clashPos = new THREE.Vector3(
              Math.random() * 6 - 3,
              1.5,
              Math.random() * 4 - 2
            );
            createClashEffect(clashPos);
            clashTimer = 0;
          }
        }

        // Phase 4: Stalemate (24s+)
        if (time > 24 && time < 28) {
          allJedi.forEach((jedi, i) => {
            jedi.position.x -= 0.01;
            jediSabers[i].position.x = jedi.position.x;
          });
          allSith.forEach((sith, i) => {
            sith.position.x += 0.01;
            sithSabers[i].position.x = sith.position.x;
          });
        }

        if (time > 28) {
          setPhase('end');
        }
      }

      // Slow camera rotation
      camera.position.x = Math.sin(time * 0.05) * 15;
      camera.position.z = Math.cos(time * 0.05) * 15;
      camera.lookAt(0, 2, 0);

      renderer.render(scene, camera);
    }

    animate();

    // Handle resize
    const handleResize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };
    window.addEventListener('resize', handleResize);

    // Load voices
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }

    return () => {
      window.removeEventListener('resize', handleResize);
      mountRef.current?.removeChild(renderer.domElement);
      renderer.dispose();
    };
  }, [phase]);

  return (
    <div style={{ width: '100vw', height: '100vh', position: 'relative', overflow: 'hidden' }}>
      <div ref={mountRef} style={{ width: '100%', height: '100%' }} />
      
      {phase === 'title' && (
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          width: '100%',
          height: '100%',
          display: 'flex',
          flexDirection: 'column',
          justifyContent: 'center',
          alignItems: 'center',
          background: 'rgba(0, 0, 0, 0.8)',
          backdropFilter: 'blur(20px)',
          animation: 'fadeOut 1.5s ease-out 2.5s forwards',
          zIndex: 10
        }}>
          <div style={{
            fontSize: '3.5rem',
            fontWeight: 'bold',
            letterSpacing: '0.3rem',
            color: '#fff',
            textShadow: '0 0 20px rgba(255, 255, 255, 0.5)',
            marginBottom: '1rem'
          }}>
            ğ‚ğğƒğ„ğ— ğ„ğğ“ğ‘ğ˜ #ğŸğŸğŸ
          </div>
          <div style={{
            fontSize: '5rem',
            fontWeight: 'bold',
            letterSpacing: '0.5rem',
            color: '#ffcc66',
            textShadow: '0 0 30px rgba(255, 200, 100, 0.8)',
            animation: 'glow 2s ease-in-out infinite alternate'
          }}>
            ğ“ğ‡ğ„ ğ‚ğˆğ•ğˆğ‹ ğ–ğ€ğ‘
          </div>
        </div>
      )}

      {phase === 'end' && (
        <div style={{
          position: 'absolute',
          bottom: '50px',
          width: '100%',
          textAlign: 'center',
          fontSize: '1.2rem',
          color: '#999',
          fontStyle: 'italic',
          animation: 'fadeIn 2s ease-in forwards',
          zIndex: 10
        }}>
          Nothing ventured, nothing gained.
        </div>
      )}

      <style>{`
        @keyframes fadeOut {
          to { opacity: 0; pointer-events: none; }
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes glow {
          from { text-shadow: 0 0 20px rgba(255, 200, 100, 0.6); }
          to { text-shadow: 0 0 40px rgba(255, 200, 100, 1); }
        }
      `}</style>
    </div>
  );
};

export default CivilWarCinematic;
